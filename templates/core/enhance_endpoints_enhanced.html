{% extends 'core/base.html' %}
{% load static %}

{% block title %}Enhance API Endpoints{% endblock %}

{% block extra_css %}
<style>
    .enhancement-page {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .page-header {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        text-align: center;
        border-left: 4px solid #007bff;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .endpoint-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        border-left: 4px solid #28a745;
    }
    
    .endpoint-card.needs-enhancement {
        border-left-color: #ffc107;
    }
    
    .endpoint-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }
    
    .method-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.8rem;
        margin-right: 0.75rem;
    }
    
    .method-get { background: #007bff; color: white; }
    .method-post { background: #28a745; color: white; }
    .method-put { background: #ffc107; color: black; }
    .method-delete { background: #dc3545; color: white; }
    .method-patch { background: #6f42c1; color: white; }
    
    .endpoint-path {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-enhanced {
        background: #d4edda;
        color: #155724;
    }
    
    .status-needs-enhancement {
        background: #fff3cd;
        color: #856404;
    }
    
    .endpoint-body {
        padding: 1.5rem;
    }
    
    .description-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #6c757d;
        font-style: italic;
    }
    
    .enhanced-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #155724;
    }
    
    .parameter-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #fff;
    }
    
    .parameter-item strong {
        color: #495057;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
    }
    
    .btn-enhance {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-enhance:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
    }
    
    .btn-llm {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-left: 0.5rem;
    }
    
    .btn-llm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
    }
    
    .progress-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: none;
    }
    
    .progress-item {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .progress-item.processing {
        background: #fff3cd;
        border-left: 3px solid #ffc107;
    }
    
    .progress-item.completed {
        background: #d1e7dd;
        border-left: 3px solid #198754;
    }
    
    .progress-item.error {
        background: #f8d7da;
        border-left: 3px solid #dc3545;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert-custom {
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.375rem;
    }
    
    .alert-success {
        color: #0f5132;
        background-color: #d1e7dd;
        border-color: #badbcc;
    }
    
    .alert-danger {
        color: #842029;
        background-color: #f8d7da;
        border-color: #f5c2c7;
    }

    .alert-info {
        color: #055160;
        background-color: #cff4fc;
        border-color: #b3e5fc;
    }
</style>
{% endblock %}

{% block content %}
<div class="enhancement-page">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="fas fa-edit text-primary"></i> Enhance API Endpoints
                    </h2>
                    <p class="text-muted mb-0">Review and enhance endpoint descriptions for better tool generation</p>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-secondary" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </button>
                    <button class="btn btn-warning ml-2" id="bulkGenerate" style="display: none;">
                        <i class="fas fa-magic"></i> Bulk Generate All
                    </button>
                    <button class="btn btn-success ml-2" id="regenerateYaml" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Regenerate YAML with Enhancements
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="endpointsEnhanced">0</div>
                <div class="stat-label">Endpoints Enhanced</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="parametersEnhanced">0</div>
                <div class="stat-label">Parameters Enhanced</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="yamlFileName">Not Set</div>
                <div class="stat-label">YAML File</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completionPercent">0%</div>
                <div class="stat-label">Completion</div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Bulk Generation Progress -->
        <div class="progress-container" id="bulkProgress">
            <h5 class="mb-3">
                <i class="fas fa-magic text-primary"></i> Bulk Generation Progress
                <button type="button" class="btn btn-sm btn-outline-secondary float-right" id="cancelBulk">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </h5>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                     style="width: 0%" id="overallProgress">0%</div>
            </div>
            <div id="progressItems"></div>
        </div>

        <!-- Endpoints List -->
        <div id="endpointsList">
            <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="mt-2 text-muted">Loading endpoints...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No API endpoints found</h4>
            <p class="text-muted">Please generate API endpoints first or select a different YAML file.</p>
        </div>
    </div>
</div>

<!-- Enhancement Modal -->
<div class="modal fade" id="enhanceModal" tabindex="-1" aria-labelledby="enhanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enhanceModalLabel">Enhance Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="enhancementForm">
                    <div class="mb-3">
                        <label class="form-label"><strong>Original Description:</strong></label>
                        <div id="originalDescription" class="description-box"></div>
                    </div>
                    <div class="mb-3">
                        <label for="enhancedSummary" class="form-label"><strong>Enhanced Summary:</strong></label>
                        <input type="text" class="form-control" id="enhancedSummary" placeholder="Enter a brief summary...">
                    </div>
                    <div class="mb-3">
                        <label for="enhancedDescription" class="form-label"><strong>Enhanced Description:</strong></label>
                        <textarea class="form-control" id="enhancedDescription" rows="5" placeholder="Enter enhanced description..."></textarea>
                        <div class="form-text">Provide a clear, detailed description of what this endpoint does.</div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-llm" id="generateLLM">
                            <i class="fas fa-magic"></i> Generate with AI
                        </button>
                        <small class="text-muted ml-2">Use AI to generate enhanced descriptions automatically</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEnhancement">Save Enhancement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let yamlFileId = '{{ yaml_file_id }}';
    let currentEndpointId = null;
    let currentEndpointData = null;
    
    // Initialize page
    if (yamlFileId && yamlFileId !== 'None') {
        loadEndpointsData();
    } else {
        showError('No YAML file specified. Please select a YAML file to enhance.');
        $('#emptyState').show();
        $('#endpointsList').hide();
    }

    // Load endpoints with their descriptions
    function loadEndpointsData() {
        $.get(`/api/tools-generator/yaml-files/endpoints_with_descriptions/?yaml_file=${yamlFileId}`)
        .done(function(response) {
            if (response.status === 'success') {
                displayEndpoints(response.data);
                loadSummaryStats();
            } else {
                showError('Error loading endpoints: ' + response.message);
                $('#emptyState').show();
            }
        })
        .fail(function(xhr) {
            showError('Failed to load endpoints: ' + (xhr.responseJSON?.message || 'Unknown error'));
            $('#emptyState').show();
        })
        .always(function() {
            $('#endpointsList .loading-spinner').parent().hide();
        });
    }

    // Load summary statistics
    function loadSummaryStats() {
        $.get(`/api/tools-generator/yaml-files/enhancement_summary/?yaml_file=${yamlFileId}`)
        .done(function(response) {
            if (response.status === 'success') {
                updateStats(response.data);
            }
        });
    }

    // Display endpoints
    function displayEndpoints(data) {
        const container = $('#endpointsList');
        
        if (!data.endpoints || data.endpoints.length === 0) {
            $('#emptyState').show();
            return;
        }
        
        // Store endpoints for bulk processing
        currentEndpoints = data.endpoints;

        const endpointsHtml = data.endpoints.map(endpoint => {
            const hasEnhancement = endpoint.has_enhancement;
            const statusBadge = hasEnhancement 
                ? '<span class="status-badge status-enhanced"><i class="fas fa-check"></i> Enhanced</span>'
                : '<span class="status-badge status-needs-enhancement"><i class="fas fa-exclamation"></i> Needs Enhancement</span>';
            
            const currentDescription = endpoint.enhanced_description || endpoint.original_description || 'No description available';
            const currentSummary = endpoint.enhanced_summary || endpoint.original_summary || '';
            
            return `
                <div class="endpoint-card ${hasEnhancement ? '' : 'needs-enhancement'}">
                    <div class="endpoint-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="method-badge method-${endpoint.method.toLowerCase()}">${endpoint.method}</span>
                                <span class="endpoint-path">${endpoint.path}</span>
                            </div>
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="endpoint-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>Description</h6>
                                <div class="${endpoint.enhanced_description ? 'enhanced-box' : 'description-box'}">
                                    ${currentDescription}
                                </div>
                                
                                ${currentSummary ? `
                                <h6>Summary</h6>
                                <div class="${endpoint.enhanced_summary ? 'enhanced-box' : 'description-box'}">
                                    ${currentSummary}
                                </div>
                                ` : ''}
                                
                                ${Object.keys(endpoint.parameters || {}).length > 0 ? `
                                <h6>Parameters (${Object.keys(endpoint.parameters).length})</h6>
                                <div class="parameters-list">
                                    ${Object.entries(endpoint.parameters).map(([name, param]) => {
                                        const enhancement = endpoint.parameter_enhancements[name];
                                        const paramDesc = enhancement?.enhanced_description || param.description || 'No description';
                                        return `
                                            <div class="parameter-item">
                                                <strong>${name}</strong> (${param.type || 'string'})
                                                ${param.required ? '<span class="badge badge-warning">Required</span>' : '<span class="badge badge-secondary">Optional</span>'}
                                                <div class="${enhancement ? 'enhanced-box' : 'description-box'} mt-2">
                                                    ${paramDesc}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                ` : ''}
                            </div>
                            <div class="col-md-4 text-right">
                                <button class="btn btn-enhance enhance-btn" data-endpoint-id="${endpoint.id}" data-endpoint='${JSON.stringify(endpoint).replace(/'/g, "&apos;")}'>
                                    <i class="fas fa-edit"></i> ${hasEnhancement ? 'Edit Enhancement' : 'Enhance Description'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.html(endpointsHtml);
        bindEventHandlers();
    }

    // Bind event handlers
    function bindEventHandlers() {
        $('.enhance-btn').off('click').on('click', function() {
            const endpointData = JSON.parse($(this).attr('data-endpoint').replace(/&apos;/g, "'"));
            currentEndpointId = endpointData.id;
            currentEndpointData = endpointData;
            openEnhanceModal(endpointData);
        });
    }

    // Open enhance modal
    function openEnhanceModal(endpointData) {
        $('#enhanceModalLabel').text(`Enhance: ${endpointData.method} ${endpointData.path}`);
        
        const originalDesc = endpointData.original_description || 'No description available';
        $('#originalDescription').html(originalDesc);
        
        $('#enhancedSummary').val(endpointData.enhanced_summary || '');
        $('#enhancedDescription').val(endpointData.enhanced_description || '');
        
        $('#enhanceModal').modal('show');
    }

    // Generate LLM description
    $('#generateLLM').on('click', function() {
        if (!currentEndpointData) {
            showError('No endpoint data available. Please close and reopen the enhancement modal.');
            return;
        }
        
        console.log('Sending endpoint data:', currentEndpointData);
        
        const btn = $(this);
        const originalText = btn.html();
        
        btn.prop('disabled', true).html('<span class="loading-spinner"></span> Generating...');
        
        $.ajax({
            url: '/api/tools-generator/yaml-files/generate_llm_description/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                endpoint_data: currentEndpointData
            }),
            success: function(response) {
                if (response.status === 'success') {
                    $('#enhancedSummary').val(response.data.enhanced_summary);
                    $('#enhancedDescription').val(response.data.enhanced_description);
                    showSuccess('AI description generated successfully! You can review and modify it before saving.');
                } else {
                    showError('Failed to generate description: ' + response.message);
                }
            },
            error: function(xhr) {
                if (xhr.status === 503) {
                    showError('AI service is not available. Please configure OpenAI API key or enhance descriptions manually.');
                } else {
                    showError('Error generating description: ' + (xhr.responseJSON?.message || 'Unknown error'));
                }
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Save enhancement
    $('#saveEnhancement').on('click', function() {
        const summary = $('#enhancedSummary').val().trim();
        const description = $('#enhancedDescription').val().trim();
        
        if (!summary && !description) {
            showError('Please provide either a summary or description');
            return;
        }
        
        console.log('Saving enhancement for endpoint ID:', currentEndpointId);
        console.log('Current endpoint data:', currentEndpointData);
        
        if (!currentEndpointId) {
            showError('No endpoint ID available. Please close and reopen the enhancement modal.');
            return;
        }
        
        const btn = $(this);
        const originalText = btn.text();
        btn.prop('disabled', true).text('Saving...');
        
        $.ajax({
            url: '/api/tools-generator/yaml-files/save_enhancement/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                yaml_file_id: yamlFileId,
                endpoint_data: currentEndpointData,
                enhanced_summary: summary,
                enhanced_description: description
            }),
            success: function(response) {
                if (response.status === 'success') {
                    showSuccess('Enhancement saved successfully!');
                    $('#enhanceModal').modal('hide');
                    loadEndpointsData(); // Reload the page
                } else {
                    showError('Failed to save enhancement: ' + response.message);
                }
            },
            error: function(xhr) {
                showError('Error saving enhancement: ' + (xhr.responseJSON?.message || 'Unknown error'));
            },
            complete: function() {
                btn.prop('disabled', false).text(originalText);
            }
        });
    });

    // Update statistics
    function updateStats(data) {
        $('#endpointsEnhanced').text(data.enhanced_endpoints || 0);
        $('#parametersEnhanced').text(data.enhanced_parameters || 0);
        $('#yamlFileName').text(data.yaml_file || 'Not Set');
        
        const totalEndpoints = data.total_endpoints || 0;
        const enhanced = data.enhanced_endpoints || 0;
        const percent = totalEndpoints > 0 ? Math.round((enhanced / totalEndpoints) * 100) : 0;
        $('#completionPercent').text(percent + '%');
        
        // Show bulk generate button if there are endpoints to enhance
        const needsEnhancement = totalEndpoints - enhanced;
        if (needsEnhancement > 0) {
            $('#bulkGenerate').show();
        }
        
        // Show regenerate button if there are enhancements
        if (enhanced > 0) {
            $('#regenerateYaml').show();
        }
    }

    // Bulk generation functionality
    let bulkGenerationCancelled = false;
    let currentEndpoints = [];
    
    $('#bulkGenerate').on('click', function() {
        if (!currentEndpoints || currentEndpoints.length === 0) {
            showError('No endpoints available for bulk generation.');
            return;
        }
        
        const needsEnhancement = currentEndpoints.filter(ep => !ep.has_enhancement);
        if (needsEnhancement.length === 0) {
            showSuccess('All endpoints are already enhanced!');
            return;
        }
        
        if (!confirm(`This will generate AI descriptions for ${needsEnhancement.length} endpoints. This may take several minutes. Continue?`)) {
            return;
        }
        
        startBulkGeneration(needsEnhancement);
    });
    
    $('#cancelBulk').on('click', function() {
        bulkGenerationCancelled = true;
        $('#bulkProgress').hide();
        showInfo('Bulk generation cancelled.');
    });

    // Regenerate YAML with enhancements
    $('#regenerateYaml').on('click', function() {
        if (!yamlFileId) {
            showError('No YAML file selected for regeneration.');
            return;
        }
        
        if (!confirm('This will regenerate the YAML file with all current enhancements. The existing file will be updated. Continue?')) {
            return;
        }
        
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<span class="loading-spinner"></span> Regenerating...');
        
        $.ajax({
            url: '/api/tools-generator/yaml-files/' + yamlFileId + '/regenerate_with_enhancements/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(response) {
                if (response.status === 'success') {
                    showSuccess('YAML file regenerated successfully with all enhancements!');
                    // Optionally reload the page to show updated data
                    setTimeout(() => {
                        loadEndpointsData();
                    }, 1500);
                } else {
                    showError('Failed to regenerate YAML: ' + response.message);
                }
            },
            error: function(xhr) {
                showError('Error regenerating YAML: ' + (xhr.responseJSON?.message || 'Unknown error'));
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    async function startBulkGeneration(endpoints) {
        bulkGenerationCancelled = false;
        $('#bulkProgress').show();
        $('#progressItems').empty();
        $('#bulkGenerate').prop('disabled', true).html('<span class="loading-spinner"></span> Processing...');
        
        let completed = 0;
        let successful = 0;
        let errors = 0;
        
        for (let i = 0; i < endpoints.length && !bulkGenerationCancelled; i++) {
            const endpoint = endpoints[i];
            const progressId = `progress-${i}`;
            
            // Add progress item
            $('#progressItems').append(`
                <div class="progress-item processing" id="${progressId}">
                    <div class="spinner-border spinner-border-sm text-warning mr-2" role="status"></div>
                    <span class="flex-grow-1">${endpoint.method} ${endpoint.path}</span>
                    <span class="badge badge-warning">Processing</span>
                </div>
            `);
            
            try {
                // Generate description for this endpoint
                const result = await generateSingleDescription(endpoint);
                
                if (result.success) {
                    // Save the enhancement
                    const saveResult = await saveSingleEnhancement(endpoint, result.data);
                    
                    if (saveResult.success) {
                        $(`#${progressId}`).removeClass('processing').addClass('completed')
                            .find('.spinner-border').removeClass('spinner-border text-warning').addClass('fas fa-check text-success')
                            .end().find('.badge').removeClass('badge-warning').addClass('badge-success').text('Completed');
                        successful++;
                    } else {
                        throw new Error(saveResult.message || 'Failed to save enhancement');
                    }
                } else {
                    throw new Error(result.message || 'Failed to generate description');
                }
                
            } catch (error) {
                console.error('Error processing endpoint:', error);
                $(`#${progressId}`).removeClass('processing').addClass('error')
                    .find('.spinner-border').removeClass('spinner-border text-warning').addClass('fas fa-times text-danger')
                    .end().find('.badge').removeClass('badge-warning').addClass('badge-danger').text('Error')
                    .end().append(`<small class="text-danger ml-2">${error.message}</small>`);
                errors++;
            }
            
            completed++;
            
            // Update overall progress
            const percent = Math.round((completed / endpoints.length) * 100);
            $('#overallProgress').css('width', percent + '%').text(percent + '%');
            
            // Small delay to avoid overwhelming the API
            if (i < endpoints.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        // Reset button state
        $('#bulkGenerate').prop('disabled', false).html('<i class="fas fa-magic"></i> Bulk Generate All');
        
        // Show completion message
        if (bulkGenerationCancelled) {
            showInfo(`Bulk generation cancelled. Processed ${completed} of ${endpoints.length} endpoints.`);
        } else {
            showSuccess(`Bulk generation completed! Successfully enhanced ${successful} endpoints. ${errors > 0 ? `${errors} errors occurred.` : ''}`);
            // Reload the page to show updated enhancements
            setTimeout(() => {
                loadEndpointsData();
                $('#bulkProgress').hide();
            }, 2000);
        }
    }
    
    function generateSingleDescription(endpoint) {
        return new Promise((resolve) => {
            $.ajax({
                url: '/api/tools-generator/yaml-files/generate_llm_description/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    endpoint_data: endpoint
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        resolve({ success: true, data: response.data });
                    } else {
                        resolve({ success: false, message: response.message });
                    }
                },
                error: function(xhr) {
                    const message = xhr.responseJSON?.message || 'Unknown error';
                    resolve({ success: false, message: message });
                }
            });
        });
    }
    
    function saveSingleEnhancement(endpoint, enhancementData) {
        return new Promise((resolve) => {
            $.ajax({
                url: '/api/tools-generator/yaml-files/save_enhancement/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    yaml_file_id: yamlFileId,
                    endpoint_data: endpoint,
                    enhanced_summary: enhancementData.enhanced_summary || '',
                    enhanced_description: enhancementData.enhanced_description || ''
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        resolve({ success: true });
                    } else {
                        resolve({ success: false, message: response.message });
                    }
                },
                error: function(xhr) {
                    const message = xhr.responseJSON?.message || 'Unknown error';
                    resolve({ success: false, message: message });
                }
            });
        });
    }

    // Utility functions
    function showSuccess(message) {
        $('#messages').html(`
            <div class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
    }

    function showError(message) {
        $('#messages').html(`
            <div class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
    }

    function showInfo(message) {
        $('#messages').html(`
            <div class="alert alert-info alert-custom alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
    }
});
</script>
{% endblock %}